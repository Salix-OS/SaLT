#!/bin/sh
# vim: set syn=sh ai et sw=2 st=2 ts=2 tw=0:
# Clean up script launched when coming back to the initrd of SaLT before halting or rebooting.

export PATH=:/usr/sbin:/usr/bin:/sbin:/bin
if [ -f /lib/libSaLT ]; then
  . /lib/libSaLT
elif [ -f /mnt/salt/lib/libSaLT ]; then
  . /mnt/salt/lib/libSaLT
else
  echo "libSaLT not found, cannot proceed further" >&2
  exit 1
fi

echodebug "cleanup: called with: $0 $@"
d=$(dirname $0)
orig=$0.orig
for f in halt reboot poweroff; do
  if [ -e $d/$f.orig -a ! -L $d/$f.orig ]; then
    orig=$d/$f.orig
    break
  fi
done
echo "$@"|grep -q -- -w
if [ $? -eq 0 ]; then
  echodebug "cleanup: '-w' detected, will run: $orig $@"
  "$orig" "$@"
  exit $?
fi

RL=$(runlevel|cut -d' ' -f2)
[ "$RL" = "unknown" ] && RL=$RUNLEVEL
[ -z "$RL" ] && RL=$runlevel
[ -z "$RL" ] && RL=0
if [ "$RL" -ne 0 -a "$RL" -ne 6 ]; then
  echodebug "cleanup: not in runlevel 0 or 6, will exec: $orig $@"
  exec "$orig" "$@"
  exit 0
fi

cd /

if [ -z "$SALT_CLEANUP_IS_RUNNING" ]; then
  export SALT_CLEANUP_IS_RUNNING=1
  echoinfo "*** Live system cleanup ***"
  mount -o remount,rw /
  echo 'rootfs /mnt/salt rootfs ro 0 0' >> /etc/mtab
  mount -o remount,ro /
  echodebug "Rexecuting in chroot: $0 $@"
  change_root_to_initrd /cleanup "$0" "$@"
  fumble "Rexecuting cleanup: this line must never be executed!"
fi

export CMD="$@"
if [ ! -e /tmp/distro_infos ]; then
  fumble "/tmp/distro_infos not found. This is really weird.\nAre you running from a Live environment?"
else
  DISTRO_DEV=$(cut -d: -f1 /tmp/distro_infos)
  DISTRO_MP=$(cut -d: -f2 /tmp/distro_infos)
fi
# ensure / is writable.
mount -o remount,rw /
sync
debugshell
debuglog 'Remounting /mnt/union read/write'
mount -o remount,rw /mnt/union
debuglog 'Uninstalling hookers in /mnt/union'
uninstall_hookers /mnt/union
debugshell
# remove any /mnt/union/dev/initctl file
rm -f /mnt/union/dev/initctl
debugshell
infolog 'Killing remaining process'
kill_all_before $$
debugshell
debuglog 'Umount sub-mounts in /mnt/union'
umount_submounts_in /mnt/union
debugshell
debuglog 'Unloading modules...'
for m in /mnt/modules/*; do
  infolog "  - Unloading $m"
  unload_module "$m"
  debugshell
done
rmdir /mnt/modules 2>/dev/null
debuglog 'Destroying union filesystem...'
destroy_union
rm /mnt/rw
if [ -e /mnt/ram ]; then
  umount /mnt/ram || umount -l /mnt/ram
  rmdir /mnt/ram
elif [ -e /mnt/save ]; then
  umount /mnt/save || umount -l /mnt/save
  rmdir /mnt/save
fi
debugshell
umount_device "$DISTRO_DEV" >/dev/null
debugshell
eject_cd
debugshell
debuglog 'Umount what remains'
umount -a -r -d 2>/dev/null
debugshell
echoinfo "Stopping/Rebooting: $CMD"
debugshell
sync
exec "$CMD" -f
fumble 'End of cleanup: this line must never be executed!'
